# 区块链批量奖励分发系统 - 需求规格文档 (PRD)

**产品形态**: Electron 桌面应用
**版本**: v1.1
**更新时间**: 2025-11-19

---

## 📋 项目概述

### 项目目标
构建一个基于 Electron 的跨平台桌面应用，支持多链(EVM + Solana)的自动化奖励分发，用于高频营销活动的代币批量发放，具备强隐私保护能力和完善的监控机制。

### 核心价值主张
- **多链支持**: 主要支持所有EVM兼容链，辅助支持Solana
- **隐私优先**: 每次活动使用独立钱包和独立合约，防止关联追踪
- **高效批量**: 单次处理500-5000个地址，EVM采用合约批量发送
- **本地运行**: 桌面应用，数据和私钥本地存储，无需云服务器
- **零成本**: 无服务器费用，仅RPC调用成本
- **完善监控**: 实时状态跟踪、费用监控、失败重试

### 产品形态
**Electron 桌面应用** - 而非云端 Web 服务

**选择理由**:
- ✅ 运营人员使用 - 需要图形界面，零技术门槛
- ✅ 本地运行 - 无需云服务器，降低成本
- ✅ 数据隐私 - 私钥和数据本地存储
- ✅ 跨平台 - Windows、macOS、Linux 一套代码

详见 [PRODUCT_OPTIONS.md](./PRODUCT_OPTIONS.md)

---

## 🎯 业务需求

### 1. 应用场景
**主场景**: 营销活动奖励
- 空投活动
- 推广奖励
- 用户激励
- 增长黑客活动

**主要用户**: 运营人员（非技术背景）

### 2. 发放规模与频率

| 指标 | 数值 | 说明 |
|------|------|------|
| 单次地址数 | 500-5,000 | 根据活动规模浮动 |
| 发放频率 | 每天或实时 | 高频发放场景 |
| 完成时间 | 30分钟-1小时 | 常规速度,平衡成本 |
| Gas费承担 | 100%平台承担 | 用户零成本领取 |

### 3. 支持的区块链

#### 3.1 EVM链(主要)
- **要求**: 支持所有EVM兼容链
- **重点链**:
  - Ethereum主网
  - L2网络(Arbitrum, Optimism, Base等)
  - 侧链(BSC, Polygon等)
- **实现方式**: BatchAirdrop 通用合约

#### 3.2 Solana(辅助)
- **代币标准**: SPL Token
- **使用比例**: <20%活动
- **实现方式**: 直接 SPL Token 转账，**无需智能合约** ⭐

### 4. 隐私保护需求

#### 4.1 核心隐私要求
- ✅ **隐藏发送方身份**: 每次活动使用全新独立钱包
- ✅ **防止关联分析**: 不同活动间无法通过链上数据关联
- ⚠️ **接收方列表**: 链上公开(批量发送必然暴露)
- ⚠️ **发放金额**: 链上公开(交易透明性要求)

#### 4.2 实现策略
1. **独立钱包**: 每次活动创建新的部署账户
2. **独立合约**: 每次EVM活动部署新的Airdrop合约实例
3. **资金隔离**: 活动间资金流转无关联
4. **记录保留**: 本地数据库保存所有信息供审计

---

## 🔧 功能需求

### F1. 钱包管理

#### F1.1 自动生成独立钱包
- **触发时机**: 每次新活动创建时
- **生成方式**: 系统自动生成HD钱包
- **存储方式**: AES-256-GCM加密存储私钥到本地
- **使用范围**: 单次活动独占,不跨活动复用

#### F1.2 私钥管理
- **加密算法**: AES-256-GCM
- **主密钥**: 存储在 `~/.config/batch-airdrop/.masterkey`，权限600
- **访问控制**: 仅主进程可解密
- **导出功能**: 支持导出活动钱包私钥（加密或明文）⭐
- **生命周期**: 活动结束后可选销毁(保留地址记录)

#### F1.3 资金管理（外部操作）⭐
- **显示地址**: 创建活动后立即显示钱包地址
- **充值提示**: 显示需要转入的代币和Gas费数量
- **余额监控**: 实时查询链上余额，检测是否充足
- **外部充值**: 运营人员使用外部钱包（MetaMask等）手动转账
- **余额检查**: 发送前确认余额充足，不足则禁用发送按钮

#### F1.4 私钥导出 ⭐
- **导出时机**: 活动创建后、活动详情页
- **导出格式**:
  - 明文私钥（复制到剪贴板）
  - 二维码（手机钱包扫描）
  - Keystore文件（加密JSON）
- **安全警告**: 导出前显示安全提示
- **用途**:
  - 导入到MetaMask等钱包进行转账
  - 备份私钥
  - 活动结束后手动回收剩余资金

---

### F2. 合约管理(EVM链)

#### F2.1 合约自动部署
- **部署时机**: 每次EVM活动独立部署新合约
- **合约类型**: BatchAirdrop批量发送合约
- **部署账户**: 使用活动独立钱包部署
- **构造参数**: 代币地址

#### F2.2 合约功能要求
```solidity
核心功能:
- batchTransfer(address[] recipients, uint256[] amounts)
- emergencyPause() // 紧急暂停
- withdrawRemaining() // 提取剩余代币
- destruct() // 可选:自毁合约
```

#### F2.3 合约生命周期管理
- ✅ **保留记录**: 保存合约地址、部署时间、交易哈希
- ✅ **资金回收**: 发送完成后回收剩余代币
- ⚠️ **自动销毁**: 可选功能,增加隐私但失去审计能力
- ✅ **紧急暂停**: 异常情况下可暂停合约

---

### F3. Solana 发送（无合约） ⭐ 新

#### F3.1 实现方式
- **直接转账**: 使用 SPL Token 的 `transfer` 指令
- **无需合约**: 不需要部署任何程序
- **并发发送**: 利用 Solana 高 TPS 并发处理

#### F3.2 流程对比

| 步骤 | EVM链 | Solana |
|------|-------|--------|
| 1 | 创建钱包 | 创建钱包 |
| 2 | 充值代币+Gas | 充值SPL代币+SOL |
| 3 | 部署合约 | ❌ 跳过 |
| 4 | 转代币到合约 | ❌ 跳过 |
| 5 | 调用batchTransfer | 直接transfer |
| 6 | 回收剩余代币 | 回收剩余代币 |

#### F3.3 费用对比
- **EVM**: 部署合约 ~$50 + 批量发送 ~$200 (Polygon)
- **Solana**: 无部署成本 + 转账 ~$5 (5000地址)

---

### F4. 批量发送功能

#### F4.1 EVM链批量发送
- **实现方式**: 智能合约批量transfer
- **分批策略**:
  - 单批上限: 100-200地址(根据gas limit)
  - 自动分批: 5000地址自动分25批发送
- **Gas优化**:
  - 使用EIP-1559动态Gas价格
  - 批次大小动态调整

#### F4.2 Solana批量发送
- **实现方式**: 构建多个Transfer指令
- **并发控制**: 控制并发数（推荐50）
- **失败重试**: 单笔失败不影响其他

#### F4.3 地址列表管理
- **输入方式**:
  - ✅ CSV文件上传（拖拽）
  - ✅ API接口传入（可扩展）
- **数据验证**:
  - 地址格式校验
  - 重复地址检测(后端)
  - 金额合法性检查

---

### F5. Gas 自动获取和预估 ⭐ 新

#### F5.1 实时Gas价格获取
- **数据源**: 直接从链上获取 `provider.getFeeData()`
- **备用源**: Etherscan Gas Tracker API
- **缓存策略**: 本地缓存10秒，后台自动更新
- **发送前**: 强制刷新获取最新价格

#### F5.2 智能预估逻辑
```typescript
预估Gas = 合约部署 + 代币转账 + (批量发送 × 批次数) + 20%缓冲
```

- **精确计算**: 使用 `estimateGas` 模拟真实交易
- **动态调整**: 根据实际批次大小调整
- **USD换算**: 实时获取 ETH/USD 价格

#### F5.3 Gas策略选择
- **经济模式**: 低Gas价格，等待时间较长
- **标准模式**: 平衡价格和速度（默认）
- **快速模式**: 高Gas价格，优先确认
- **自定义**: 用户手动设置Gas上限

#### F5.4 UI展示
- 创建活动时显示预估费用
- 实时Gas价格监控（仪表盘顶部）
- 颜色预警：绿色正常/黄色偏高/红色过高

---

### F6. 交易前预览和确认 ⭐ 新

#### F6.1 两阶段确认

**第一阶段：创建活动**
- 填写基本信息
- 上传地址列表
- 显示初步预估
- 保存为"待发送"状态

**第二阶段：执行前确认**
- 显示详细预览信息
- 实时刷新Gas价格
- 余额充足性检查
- 用户明确点击"确认发送"

#### F6.2 预览信息清单
必须展示的信息：
1. **活动信息**: 名称、链、代币、合约地址
2. **接收者**: 总数、总金额、地址列表预览
3. **费用**: 当前Gas价格、预估消耗、USD成本
4. **钱包余额**: 主钱包余额、所需金额、是否充足
5. **风险提示**: 交易不可撤销、核对地址

#### F6.3 特殊处理

**高价值警告**（触发条件）:
- 总金额 > $10,000
- Gas费用 > $500
- 地址数 > 3,000

**余额不足提示**:
- 明确显示缺少的金额
- 禁用"确认发送"按钮
- 提供"去充值"引导

#### F6.4 确认流程
```
创建活动 → 保存(CREATED)
    ↓
点击"开始发送"
    ↓
弹出预览对话框
    ↓
展示详细信息 + 实时Gas
    ↓
勾选"我已确认"
    ↓
点击"确认并开始发送"
    ↓
真正执行交易
```

---

### F7. 监控与告警

#### F7.1 交易状态监控
- **实时追踪**: 每笔交易的pending/confirmed/failed状态
- **可视化**: Dashboard展示发送进度
- **数据存储**: 所有交易记录入本地数据库

#### F7.2 Gas费用监控
- **实时计算**: 累计已消耗gas费
- **预算预警**: 超过预设阈值时告警
- **链对比**: 不同链的费用对比分析

#### F7.3 失败重试机制
- **自动重试**:
  - Gas不足: 自动提高gas price重试
  - Nonce错误: 自动修正
  - 网络超时: 指数退避重试
- **最大重试**: 3次后标记为失败需人工介入
- **智能判断**: 区分可重试错误和永久性错误

#### F7.4 桌面通知
- **完成通知**: 活动发送完成时弹出桌面通知
- **错误通知**: 发生严重错误时提醒
- **可配置**: 用户可在设置中开关通知

---

### F8. 审计和记录导出 ⭐ 新

#### F8.1 支持的导出格式

**1. CSV格式** - 用于Excel分析
```csv
活动ID,活动名称,区块链,代币,接收地址,金额,状态,交易哈希,Gas消耗,时间
a1b2c3,2025-01营销,Polygon,USDC,0x123...,100,成功,0xabc...,0.004,2025-11-19 14:30
```

**2. PDF报告** - 正式审计文档
- 封面：活动信息、Logo
- 概要：统计数据、成功率、Gas消耗
- 详细列表：所有交易记录
- 图表：Gas趋势、成功率分布

**3. JSON格式** - 程序化处理
```json
{
  "campaign": {...},
  "summary": {...},
  "transactions": [...]
}
```

#### F8.2 导出场景

| 场景 | 导出内容 | 格式 | 触发位置 |
|------|---------|------|---------|
| 单个活动报告 | 该活动所有记录 | CSV/PDF/JSON | 活动详情页 |
| 批量活动报告 | 多个活动汇总 | CSV/PDF | 历史页面 |
| 自定义范围 | 时间范围筛选 | CSV | 历史页面 |
| 仅失败记录 | 失败交易列表 | CSV | 活动详情页 |

#### F8.3 导出内容

**基础字段**（必含）:
- 活动ID、名称、链、代币
- 接收地址、金额、状态
- 交易哈希、Gas消耗
- 时间戳

**扩展字段**（PDF报告）:
- 创建者、钱包地址、合约地址
- Gas价格、确认时间
- 批次信息、重试次数
- 错误信息

#### F8.4 UI交互
- 活动详情页："📥 导出报告"按钮
- 选择格式对话框
- 自动打开文件所在文件夹
- 成功提示

#### F8.5 审计追溯
- 所有操作不可篡改（SQLite数据库）
- 删除活动前强制导出报告
- 支持按时间范围查询历史

---

### F9. 链和RPC管理 ⭐ 新

#### F9.1 EVM链管理

**内置链预设**:
- Ethereum Mainnet
- Polygon
- Arbitrum One
- Optimism
- Base
- BSC (Binance Smart Chain)
- Avalanche C-Chain

**添加自定义EVM链**:
- **必填字段**:
  - 链名称 (例如: "zkSync Era")
  - Chain ID (例如: 324)
  - RPC URL (例如: "https://mainnet.era.zksync.io")
  - 区块浏览器 URL (例如: "https://explorer.zksync.io")
  - 原生代币符号 (例如: "ETH")
  - 原生代币精度 (默认: 18)
- **可选字段**:
  - 备用RPC URL (故障切换)
  - 网络图标 URL
- **验证逻辑**:
  - 自动检测Chain ID是否匹配
  - RPC连通性测试
  - 获取最新区块验证
- **管理操作**:
  - 编辑链配置
  - 删除自定义链(内置链不可删除)
  - 启用/禁用链(隐藏不常用的链)

#### F9.2 Solana网络管理

**网络类型**:
- Mainnet-beta (生产环境)
- Devnet (开发测试)
- Testnet (测试网络)
- 自定义网络

**RPC节点管理**:
- **添加RPC节点**:
  - 节点名称 (例如: "Quicknode 主节点")
  - RPC URL (例如: "https://api.mainnet-beta.solana.com")
  - WebSocket URL (可选)
  - 优先级 (1-10,数字越小优先级越高)
- **RPC健康检查**:
  - 延迟测试 (ping时间)
  - 可用性检测 (getHealth)
  - TPS速率测试
  - 自动标记不可用节点
- **自动切换机制**:
  - 主节点失败自动切换到备用节点
  - 按优先级顺序尝试
  - 实时显示当前使用的RPC
- **性能监控**:
  - 显示每个节点的延迟
  - 成功率统计
  - 最近24小时可用性

#### F9.3 RPC配置持久化

- **存储位置**: 本地SQLite数据库 `chains` 表
- **字段设计**:
```sql
CREATE TABLE chains (
  id INTEGER PRIMARY KEY,
  type TEXT, -- 'evm' or 'solana'
  chain_id INTEGER, -- EVM only
  name TEXT NOT NULL,
  rpc_url TEXT NOT NULL,
  rpc_backup TEXT, -- 备用RPC
  explorer_url TEXT,
  symbol TEXT, -- 原生代币
  decimals INTEGER,
  enabled BOOLEAN DEFAULT 1,
  is_custom BOOLEAN DEFAULT 0,
  created_at TEXT
);

CREATE TABLE solana_rpcs (
  id INTEGER PRIMARY KEY,
  network TEXT, -- 'mainnet-beta', 'devnet', 'testnet'
  name TEXT NOT NULL,
  rpc_url TEXT NOT NULL,
  ws_url TEXT,
  priority INTEGER DEFAULT 5,
  latency INTEGER, -- ms
  uptime_24h REAL, -- 可用性百分比
  enabled BOOLEAN DEFAULT 1,
  last_checked TEXT
);
```

#### F9.4 UI交互

**EVM链管理页面**:
- 内置链列表(可启用/禁用)
- "➕ 添加自定义链"按钮
- 编辑/删除操作
- RPC测试按钮(显示延迟和状态)

**Solana RPC管理页面**:
- 按网络分组显示(Mainnet/Devnet/Testnet)
- 实时延迟和可用性指示器
- 拖拽调整优先级
- "🔄 测试所有节点"按钮

**创建活动时的链选择**:
- 仅显示已启用的链
- 显示RPC状态图标(🟢正常/🟡慢/🔴离线)
- 不可用链显示"配置RPC"提示

---

### F10. 安全功能

#### F10.1 防重复发放(后端校验)
- **实现层**: 应用层（数据库唯一约束）
- **校验逻辑**: 检查地址是否已在本活动中发放
- **响应**: 重复地址跳过并记录

#### F10.2 数据安全

**存储策略**:
- **私钥加密**: AES-256-GCM加密存储
- **主密钥保护**: 文件权限600，仅所有者可读写
- **默认位置**: 系统用户目录（升级安装不会丢失）
  - Windows: `%APPDATA%\batch-airdrop\`
  - macOS: `~/Library/Application Support/batch-airdrop/`
  - Linux: `~/.config/batch-airdrop/`

**自定义数据目录** ⭐ 新:
- **设置入口**: 设置页面 → 数据管理 → "更改数据目录"
- **选择方式**: 系统文件选择器选择目录
- **迁移功能**:
  - 自动复制现有数据到新位置
  - 验证数据完整性
  - 迁移成功后删除旧数据(可选)
  - 迁移失败自动回滚
- **限制条件**:
  - 必须有写权限
  - 不能选择系统保护目录
  - 推荐至少1GB可用空间
- **重启生效**: 更改后需重启应用
- **恢复默认**: 支持一键恢复到系统默认位置

**数据备份**:
- **手动备份**: 一键备份到指定位置
- **自动备份**: 可选每日/每周自动备份
- **备份内容**:
  - 数据库文件 (airdrop.db)
  - 加密主密钥 (.masterkey)
  - 配置文件
- **恢复功能**: 从备份文件恢复数据

#### F10.3 审计日志
- **记录内容**:
  - 谁在何时创建了活动
  - 活动配置参数
  - 所有交易记录
  - 异常和错误日志
- **保留**: 永久保存在本地数据库

---

## 📊 非功能性需求

### 性能要求

| 指标 | 目标值 |
|------|--------|
| 应用启动时间 | <5秒 |
| 5000地址发送完成 | 30-60分钟 |
| UI响应时间 | <200ms |
| 数据库查询 | <100ms |

### 可靠性
- **数据一致性**: 确保每个地址恰好收到一次(或明确失败)
- **幂等性**: 操作支持幂等,避免重复
- **容错**: 单个交易失败不影响整体流程
- **本地备份**: 支持数据库备份和恢复

### 可维护性
- **日志规范**: 结构化日志，按级别记录
- **错误追踪**: 清晰的错误提示和堆栈
- **文档**: 完整的用户手册和开发文档

### 兼容性
- **平台**: Windows 10+, macOS 10.14+, Ubuntu 18.04+
- **最小窗口**: 1000×700
- **推荐窗口**: 1200×800

---

## 🎯 成功指标

### 业务指标
- 活动创建到发送完成平均时长 <2小时
- 发送成功率 >99%
- 运营人员培训时间 <30分钟

### 技术指标
- 应用崩溃率 <0.1%
- 交易重试成功率 >95%
- 用户满意度 >4.5/5

---

## 🚧 技术风险与挑战

详见 [CHALLENGES.md](./CHALLENGES.md)

关键挑战：
1. **Gas成本控制** - L2优先策略
2. **隐私保护** - 独立钱包+合约
3. **高频性能** - Nonce管理、并发控制
4. **RPC稳定性** - 多提供者池化
5. **私钥安全** - AES加密+主密钥保护
6. **Solana并发** - 批量指令优化

---

## 📈 实施优先级

### P0 - MVP核心（必须）
- [x] 需求分析完成
- [ ] Electron框架搭建
- [ ] 钱包管理（加密存储 + 私钥导出）⭐
- [ ] 基础链管理（内置EVM链 + Solana）
- [ ] Gas自动获取和预估 ⭐
- [ ] 交易前预览确认 ⭐
- [ ] EVM链发送（带合约）
- [ ] 基础进度监控

### P1 - 生产就绪（重要）
- [ ] 记录导出（CSV/PDF/JSON）⭐
- [ ] Solana发送（无合约）⭐
- [ ] 链和RPC管理（自定义EVM链 + Solana RPC切换）⭐
- [ ] 失败重试机制
- [ ] 桌面通知
- [ ] 余额监控和外部充值流程 ⭐

### P2 - 功能增强（可选）
- [ ] 自定义数据目录 ⭐
- [ ] 数据自动备份/恢复
- [ ] RPC健康检查和自动切换
- [ ] 管理后台UI优化
- [ ] 高级统计Dashboard
- [ ] 自动更新功能

---

## 🗺️ 实施路线

详见 [ROADMAP_ELECTRON.md](./ROADMAP_ELECTRON.md)

**总周期**: 6周到生产可用版本

- Week 1: 项目搭建 + 基础框架
- Week 2: 核心功能（钱包+活动）
- Week 3: 发送逻辑 + 合约集成
- Week 4: UI完善 + 监控
- Week 5: 多链支持 + Solana
- Week 6: 打包测试 + 优化

---

## 📎 附录

### A1. 关键技术决策记录

| 决策点 | 选择 | 理由 |
|--------|------|------|
| 产品形态 | Electron桌面应用 | 运营人员友好、本地运行、零服务器成本 |
| 隐私方案 | 独立钱包+独立合约 | 平衡隐私和实现复杂度 |
| Solana实现 | 直接转账，无合约 | 简化流程，降低成本 |
| Gas获取 | 实时获取，不写死 | 适应价格波动 |
| 确认流程 | 两阶段确认 | 防止误操作，提高安全性 |
| 私钥管理 | AES加密本地存储 | 适配桌面应用场景 |
| 导出格式 | CSV/PDF/JSON | 满足不同审计需求 |

### A2. 术语表

- **EVM**: Ethereum Virtual Machine，以太坊虚拟机
- **SPL**: Solana Program Library，Solana程序库
- **Gas**: 以太坊网络上的交易费用单位
- **Gwei**: Gas价格单位，1 Gwei = 10^-9 ETH
- **Airdrop**: 空投，批量发送代币
- **HD Wallet**: 分层确定性钱包
- **IPC**: Inter-Process Communication，进程间通信

---

**文档版本**: v1.1
**最后更新**: 2025-11-19
**变更记录**:
- v1.0: 初始版本（云端Web服务）
- v1.1: 改为Electron桌面应用，新增4个需求（导出、Solana无合约、Gas自动获取、交易前确认）
